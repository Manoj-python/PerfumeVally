{% extends 'layouts/main.html' %}
{% load static %}
{% block title %}
<title>Shopping Page</title>
{% endblock title %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="{% static 'css/home.css' %}?v2" type="text/css" />
<style>
  .custom-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .favorite {
    position: absolute;
    width: 40px;
    height: 40px;
    border: 1px solid #FFF;
    border-radius: 50%;
    top: 22px;
    right: 15px;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2;
  }
  
  .favorite img {
    width: 23px;
    height: 23px;
    transition: filter 0.2s, transform 0.2s;
  }
 
  .favorite:hover img,
  .favorite.active img {
    /* Darker pink tint */
    filter: brightness(0) saturate(100%) invert(17%) sepia(98%) saturate(7492%) hue-rotate(312deg) brightness(90%) contrast(110%);
    transform: scale(1.15);
  }

  @media (min-width: 600px) {
    .custom-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
  }

  @media (min-width: 768px) {
    .custom-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 992px) {
    .custom-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .product-card-wrapper {
    display: flex;
  }

  .product-card {
    position: relative;
    overflow: hidden;
    border-radius: 6px;
    padding: 10px;
    transition: transform 0.3s ease;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    width: 90%;
    background-color: white;
  }

  .product-card:hover {
    transform: translateY(-5px);
  }

  .product-image-wrapper {
    width: 100%;
    height: 300px;
    overflow: hidden;
    position: relative;
  }

  .product-image,
  .product-hover-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: opacity 0.4s ease;
    border-radius: 6px;
  }

  .product-hover-image {
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0;
    z-index: 2;
  }

  .product-card:hover .product-hover-image {
    opacity: 1;
  }

  .addcart {
    background-color: #6D3F0BF2;
    color: white;
    font-size: 18px;
    font-family: Jomolhari;
    text-transform: capitalize;
    padding: 10px;
    text-align: center;
    border-radius: 5px;
    opacity: 0;
    transition: opacity 0.4s ease, max-height 0.4s ease;
    max-height: 0;
    overflow: hidden;
  }

  .product-card:hover .addcart,
  .product-card:hover .favorite {
    opacity: 1;
    max-height: 60px;
  }

  .addcart a {
    text-decoration: none;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 6px;
  }

  .product-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
    background-color: rgba(251, 239, 250, 0.95);
    padding: 10px 12px;
    border-radius: 6px;
    margin-top: auto;
  }

  /* Responsive Banner Styling */
  .top-banner img {
    width: 100%;
    height: 30vh;
    object-fit: cover;
    border-radius: 8px;
  }

  @media (min-width: 768px) {
    .top-banner img {
      height: 40vh;
    }
  }

  @media (min-width: 992px) {
    .top-banner img {
      height: 50vh;
    }
  }

  .banner-title-overlay h1 {
    font-size: 2rem;
  }

  @media (min-width: 768px) {
    .banner-title-overlay h1 {
      font-size: 3rem;
    }
  }
  .badge-rating {
  position: absolute;
  bottom: 70px;
  right: 10px;
  background-color: #ecebe7;
  color: #333;
  padding: 4px 8px;
  border-radius: 8px;
  font-size: 0.8rem;
  z-index: 1000;
  font-weight: 600;
  box-shadow: 0 0 4px rgba(0,0,0,0.1);
}
</style>
{% endblock extra_css %}

{% block content %}
<div class="container-fluid px-2 px-md-3">
  {% if banner %}
    <div class="top-banner mb-4 position-relative">
      <img src="{{ banner.banner_image.url }}" alt="{{ banner.title }}">
      <div class="banner-title-overlay position-absolute top-50 start-50 translate-middle text-white text-center">
        <h1 class="display-4 fw-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">{{ title }}</h1>
      </div>
    </div>
  {% endif %}

  <div class="custom-grid mb-4">
  {% for entry in combined_items %}
    <div class="product-card-wrapper">
      <div class="card product-card">

        <!-- Image -->
        <div class="product-image-wrapper">
          {% if entry.product.image1 %}
            <img src="{{ entry.product.image1.url }}" class="product-image" alt="{{ entry.product.name }}">
          {% endif %}
          {% if entry.product.image2 %}
            <img src="{{ entry.product.image2.url }}" class="product-hover-image" alt="{{ entry.product.name }}">
          {% endif %}
          <div class="favorite {% if entry.product.id in wishlist_product_ids %}active{% endif %}" 
               data-product-id="{{ entry.product.id }}">
            <img src="{% static 'images2/favorite.svg' %}" alt="Wishlist">
          </div>
        </div>

        <!-- Add to Cart -->
        <div class="addcart">
          <a href="{% url 'product_detail' entry.product.id %}">
            <img src="{% static 'images2/shopping_cart.svg' %}" alt="Cart" width="24">
            <span>Add to Cart</span>
          </a>
        </div>

        <!-- Product Info -->
        <div class="product-info-row">
          <span class="fw-bold">{{ entry.product.name }}</span>
         <span class="badge-rating">
  <i class="bi bi-star-fill me-1" style="color:#AF9164;"></i>
  {{ entry.average_rating|default:"0.0"|floatformat:1 }} | {{ entry.review_count|default:0 }}
</span>

          <span class="text-muted">
            ₹{{ entry.min_price }}
            {% if entry.min_price != entry.max_price %}
              - ₹{{ entry.max_price }}
            {% endif %}
          </span>
        </div>

      </div>
    </div>
  {% endfor %}
  </div>
</div>

 
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Favorite icon click handler
  document.querySelectorAll('.favorite').forEach(icon => {
    icon.addEventListener('click', async function(e) {
      e.preventDefault();
      const productId = this.dataset.productId;
      const isActive = this.classList.contains('active');
      const iconElem = this;

      try {
        const response = await fetch(
          isActive ? '{% url "remove_from_wishlist" %}' : '{% url "add_to_wishlist" %}', 
          {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `product_id=${productId}`
          }
        );
        
        const data = await response.json();
        if (data.success) {
          // Ensure only this icon toggles, not all
          if (isActive) {
            iconElem.classList.remove('active');
          } else {
            iconElem.classList.add('active');
          }
          // Optional: Show toast notification
          if (typeof showToast === 'function') showToast(data.message);
        } else if (data.login_required) {
          window.location.href = '{% url "email_login" %}?next=' + encodeURIComponent(window.location.pathname);
        }
      } catch (error) {
        console.error('Wishlist error:', error);
      }
    });
  });
});
</script>

{% endblock content %}